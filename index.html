<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>å®¶ç”¨ç‰©å“ç®¡å®¶</title>
  <link rel="manifest" href="manifest.json" />
  <style>
    :root {
      --primary: #4A90E2;
      --bg: #f9f9f9;
      --card-bg: white;
      --border: #ddd;
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background-color: var(--bg);
      padding: 16px;
      color: #333;
    }
    h1 {
      text-align: center;
      margin: 16px 0;
      font-size: 1.5em;
    }
    .section {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .form-group {
      margin-bottom: 12px;
    }
    label {
      display: block;
      margin-bottom: 4px;
      font-weight: bold;
      font-size: 0.9em;
    }
    input, select, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 16px; /* é˜²æ­¢ iOS Safari ç¼©æ”¾ */
    }
    button {
      background: var(--primary);
      color: white;
      border: none;
      padding: 12px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      width: 100%;
      margin-top: 8px;
    }
    .btn-row {
      display: flex;
      gap: 8px;
    }
    .btn-row button {
      width: auto;
      flex: 1;
    }
    .item-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .item-card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }
    .item-image {
      max-width: 80px;
      height: auto;
      display: block;
      margin-bottom: 8px;
      border-radius: 8px;
    }
    .item-info {
      font-size: 0.95em;
    }
    .actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 8px;
    }
    .actions button {
      padding: 6px 10px;
      font-size: 14px;
      width: auto;
    }
    .preview-container {
      margin-top: 8px;
    }
    .preview-container img {
      max-width: 100%;
      max-height: 200px;
      border-radius: 8px;
      display: block;
    }
    .stats-btns {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .stats-btns button {
      flex: 1;
      min-width: 100px;
    }
    @media (max-width: 480px) {
      .item-info-line {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }
      .item-info-line > div {
        flex: 1 1 100%;
      }
    }
  </style>
</head>
<body>
  <h1>ğŸ  å®¶åº­ç‰©å“ç®¡ç†ç³»ç»Ÿ</h1>

  <div class="section">
    <div class="form-group">
      <label>ç‰©å“åç§°ï¼ˆå¿…å¡«ï¼‰</label>
      <input id="name" type="text" placeholder="å¦‚ï¼šèºä¸åˆ€" />
    </div>
    <div class="form-group">
      <label>æ•°é‡ï¼ˆä¸ªï¼‰</label>
      <input id="quantity" type="number" min="1" value="1" />
    </div>
    <div class="form-group">
      <label>åˆ†ç±»ï¼ˆå¯é€‰ï¼‰</label>
      <input id="category" type="text" placeholder="å¦‚ï¼šå·¥å…·" />
    </div>
    <div class="form-group">
      <label>æ‰€åœ¨æˆ¿é—´ï¼ˆå¿…å¡«ï¼‰</label>
      <select id="room" required></select>
      <button type="button" id="add-room">â• æ–°å¢æˆ¿é—´</button>
    </div>
    <div class="form-group">
      <label>å®¹å™¨ï¼ˆå¯é€‰ï¼‰</label>
      <select id="container"></select>
      <button type="button" id="add-container">â• æ–°å¢å®¹å™¨</button>
    </div>
    <div class="form-group">
      <label>å±‚/æ ¼ï¼ˆå¯é€‰ï¼‰</label>
      <input id="shelf" type="text" placeholder="å¦‚ï¼šç¬¬äºŒå±‚" />
    </div>
    <div class="form-group">
      <label>å…·ä½“ä½ç½®æè¿°ï¼ˆå¯é€‰ï¼‰</label>
      <textarea id="description" rows="2" placeholder="å¦‚ï¼šçº¢è‰²å·¥å…·ç®±å†…"></textarea>
    </div>
    <div class="form-group">
      <label>ğŸ“¸ ç‚¹å‡»é€‰æ‹©ç…§ç‰‡æˆ–æ‹ç…§</label>
      <input type="file" id="image-upload" accept="image/*" capture="environment" />
      <div class="preview-container">
        <img id="image-preview" style="display:none;" />
      </div>
    </div>
    <div class="form-group">
      <label>ğŸ·ï¸ ç‚¹å‡»ä¸Šä¼ äºŒç»´ç å›¾ç‰‡ï¼ˆè‡ªåŠ¨è¯†åˆ«å†…å®¹ï¼‰</label>
      <input type="file" id="barcode-upload" accept="image/*" />
    </div>
    <button id="save-item">â• æ·»åŠ ç‰©å“</button>
  </div>

  <div class="section">
    <div id="summary">å…± 0 é¡¹ | æ€»è®¡ 0 ä¸ª</div>
    <div class="btn-row">
      <button id="export-data">ğŸ“¤ å¯¼å‡ºæ•°æ®</button>
      <button id="import-data">ğŸ“¥ å¯¼å…¥æ•°æ®</button>
      <button id="clear-all">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰</button>
    </div>
    <div class="stats-btns">
      <button id="chart-room">æŒ‰æˆ¿é—´åˆ†å¸ƒ</button>
      <button id="chart-category">æŒ‰åˆ†ç±»åˆ†å¸ƒ</button>
      <button id="chart-container">æŒ‰å®¹å™¨åˆ†å¸ƒ</button>
    </div>
  </div>

  <div class="section">
    <div class="item-list" id="item-list"></div>
  </div>

  <!-- ç¼–è¾‘æ¨¡æ€æ¡†ï¼ˆå¤ç”¨ä¸»è¡¨å•ï¼‰ -->
  <input type="hidden" id="editing-index" value="-1" />

  <script>
    // ========== æ•°æ®å­˜å‚¨ ==========
    let items = JSON.parse(localStorage.getItem('homeItems') || '[]');
    let rooms = JSON.parse(localStorage.getItem('homeRooms') || '["å®¢å…", "å§å®¤", "å¨æˆ¿", "ä¹¦æˆ¿"]');
    let containers = JSON.parse(localStorage.getItem('homeContainers') || '["æŠ½å±‰", "æŸœå­", "ç®±å­"]');

    // ========== DOM å…ƒç´  ==========
    const el = {
      name: document.getElementById('name'),
      quantity: document.getElementById('quantity'),
      category: document.getElementById('category'),
      room: document.getElementById('room'),
      container: document.getElementById('container'),
      shelf: document.getElementById('shelf'),
      description: document.getElementById('description'),
      imageUpload: document.getElementById('image-upload'),
      imagePreview: document.getElementById('image-preview'),
      saveBtn: document.getElementById('save-item'),
      summary: document.getElementById('summary'),
      itemList: document.getElementById('item-list'),
      editingIndex: document.getElementById('editing-index'),
      addRoomBtn: document.getElementById('add-room'),
      addContainerBtn: document.getElementById('add-container'),
      exportBtn: document.getElementById('export-data'),
      importBtn: document.getElementById('import-data'),
      clearBtn: document.getElementById('clear-all')
    };

    // ========== åˆå§‹åŒ– ==========
    function init() {
      renderRoomOptions();
      renderContainerOptions();
      renderItems();
      updateSummary();
      setupEventListeners();
    }

    function renderRoomOptions(selected = '') {
      el.room.innerHTML = '';
      rooms.forEach(room => {
        const opt = document.createElement('option');
        opt.value = room;
        opt.textContent = room;
        if (room === selected) opt.selected = true;
        el.room.appendChild(opt);
      });
    }

    function renderContainerOptions(selected = '') {
      el.container.innerHTML = '<option value="">æ— </option>';
      containers.forEach(container => {
        const opt = document.createElement('option');
        opt.value = container;
        opt.textContent = container;
        if (container === selected) opt.selected = true;
        el.container.appendChild(opt);
      });
    }

    function resetForm() {
      el.name.value = '';
      el.quantity.value = '1';
      el.category.value = '';
      el.shelf.value = '';
      el.description.value = '';
      el.imagePreview.style.display = 'none';
      el.imagePreview.src = '';
      el.editingIndex.value = '-1';
      el.saveBtn.textContent = 'â• æ·»åŠ ç‰©å“';
    }

    // ========== äº‹ä»¶ç›‘å¬ ==========
    function setupEventListeners() {
      el.imageUpload.addEventListener('change', handleImageUpload);
      el.addRoomBtn.addEventListener('click', addNewRoom);
      el.addContainerBtn.addEventListener('click', addNewContainer);
      el.saveBtn.addEventListener('click', saveItem);
      el.exportBtn.addEventListener('click', exportData);
      el.importBtn.addEventListener('click', importData);
      el.clearBtn.addEventListener('click', clearAll);
    }

    function handleImageUpload(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (event) => {
        el.imagePreview.src = event.target.result;
        el.imagePreview.style.display = 'block';
      };
      reader.readAsDataURL(file);
    }

    function addNewRoom() {
      const newRoom = prompt('è¯·è¾“å…¥æ–°æˆ¿é—´åç§°:');
      if (newRoom && !rooms.includes(newRoom)) {
        rooms.push(newRoom);
        localStorage.setItem('homeRooms', JSON.stringify(rooms));
        renderRoomOptions();
      }
    }

    function addNewContainer() {
      const newContainer = prompt('è¯·è¾“å…¥æ–°å®¹å™¨åç§°:');
      if (newContainer && !containers.includes(newContainer)) {
        containers.push(newContainer);
        localStorage.setItem('homeContainers', JSON.stringify(containers));
        renderContainerOptions();
      }
    }

    function saveItem() {
      const name = el.name.value.trim();
      if (!name) {
        alert('è¯·å¡«å†™ç‰©å“åç§°');
        return;
      }
      const item = {
        name,
        quantity: parseInt(el.quantity.value) || 1,
        category: el.category.value.trim(),
        room: el.room.value,
        container: el.container.value || '',
        shelf: el.shelf.value.trim(),
        description: el.description.value.trim(),
        image: el.imagePreview.src || ''
      };

      const index = parseInt(el.editingIndex.value);
      if (index >= 0) {
        items[index] = item;
      } else {
        items.push(item);
      }
      localStorage.setItem('homeItems', JSON.stringify(items));
      renderItems();
      updateSummary();
      resetForm();
    }

    function editItem(index) {
      const item = items[index];
      el.name.value = item.name;
      el.quantity.value = item.quantity;
      el.category.value = item.category || '';
      el.shelf.value = item.shelf || '';
      el.description.value = item.description || '';

      // ä¿®å¤é—®é¢˜1ï¼šæ­£ç¡®å›å¡«å®¹å™¨
      renderRoomOptions(item.room);
      renderContainerOptions(item.container);

      // ä¿®å¤é—®é¢˜3ï¼šé‡ç½®å¹¶é¢„è§ˆå›¾ç‰‡
      if (item.image) {
        el.imagePreview.src = item.image;
        el.imagePreview.style.display = 'block';
      } else {
        el.imagePreview.style.display = 'none';
      }

      el.editingIndex.value = index;
      el.saveBtn.textContent = 'âœ… ä¿å­˜ä¿®æ”¹';

      // æ»šåŠ¨åˆ°é¡¶éƒ¨
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function deleteItem(index) {
      if (confirm('ç¡®å®šåˆ é™¤æ­¤ç‰©å“ï¼Ÿ')) {
        items.splice(index, 1);
        localStorage.setItem('homeItems', JSON.stringify(items));
        renderItems();
        updateSummary();
      }
    }

    function renderItems() {
      el.itemList.innerHTML = '';
      items.forEach((item, index) => {
        const card = document.createElement('div');
        card.className = 'item-card';
        card.innerHTML = `
          ${item.image ? `<img src="${item.image}" class="item-image" />` : ''}
          <div class="item-info">
            <div><strong>${item.name}</strong> Ã— ${item.quantity}</div>
            <div>åˆ†ç±»: ${item.category || 'â€”'}</div>
            <div>ä½ç½®: ${item.room}${item.container ? ' â†’ ' + item.container : ''}${item.shelf ? ' / ' + item.shelf : ''}</div>
            ${item.description ? `<div>æè¿°: ${item.description}</div>` : ''}
          </div>
          <div class="actions">
            <button onclick="editItem(${index})">âœï¸ ç¼–è¾‘</button>
            <button onclick="deleteItem(${index})">ğŸ—‘ï¸ åˆ é™¤</button>
          </div>
        `;
        el.itemList.appendChild(card);
      });
    }

    function updateSummary() {
      const totalItems = items.length;
      const totalCount = items.reduce((sum, item) => sum + item.quantity, 0);
      el.summary.textContent = `å…± ${totalItems} é¡¹ | æ€»è®¡ ${totalCount} ä¸ª`;
    }

    function exportData() {
      const dataStr = JSON.stringify({ items, rooms, containers }, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'home-items-backup.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function importData() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = e => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = ev => {
          try {
            const data = JSON.parse(ev.target.result);
            if (data.items) {
              items = data.items;
              localStorage.setItem('homeItems', JSON.stringify(items));
            }
            if (data.rooms) {
              rooms = data.rooms;
              localStorage.setItem('homeRooms', JSON.stringify(rooms));
              renderRoomOptions();
            }
            if (data.containers) {
              containers = data.containers;
              localStorage.setItem('homeContainers', JSON.stringify(containers));
              renderContainerOptions();
            }
            renderItems();
            updateSummary();
            alert('å¯¼å…¥æˆåŠŸï¼');
          } catch (err) {
            alert('å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼é”™è¯¯');
          }
        };
        reader.readAsText(file);
      };
      input.click();
    }

    function clearAll() {
      if (confirm('æ¸…ç©ºæ‰€æœ‰ç‰©å“ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
        items = [];
        localStorage.setItem('homeItems', JSON.stringify(items));
        renderItems();
        updateSummary();
      }
    }

    // æš´éœ²å‡½æ•°ç»™å…¨å±€ï¼ˆç”¨äº inline onclickï¼‰
    window.editItem = editItem;
    window.deleteItem = deleteItem;

    // å¯åŠ¨
    init();

    // ========== PWA æ³¨å†Œ ==========
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').catch(console.warn);
      });
    }
  </script>
</body>
</html>